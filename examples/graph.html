<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Echo Nest Remix</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Echo Nest Remix:  The Internet Synthesizer">
    <meta name="author" content="Brian Whitman / Paul Lamere / Thor Kell">

    <link href="assets/css/bootstrap.css" rel="stylesheet">
    <link href="assets/css/bootstrap-responsive.css" rel="stylesheet">
    <link href="../graph/rickshaw.min.css" rel="stylesheet">

    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <style>
        .rickshaw_graph .detail .x_label { display: none }
        .rickshaw_graph .detail .item { line-height: 1.4; padding: 0.5em }
        .detail_swatch { float: right; display: inline-block; width: 10px; height: 10px; margin: 0 4px 0 0 }
        .rickshaw_graph .detail .date { color: #a0a0a0 }
    </style>

</head>

<body>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.15/jquery-ui.min.js"></script>


<script src="assets/js/bootstrap.min.js"></script>
<script type="text/javascript" src='../remix.js'></script>

<script src="../graph/d3.min.js"></script>
<script src="../graph/d3.layout.min.js"></script>
<script src="../graph/rickshaw.min.js"></script>

<script type="text/javascript">



// First-beat extraction and assembly
var apiKey = 'SWHCFHJA2PPHKX7A5';
var trackID = 'TRCYWPQ139279B3308';
var trackURL = 'audio/1451_-_D.mp3';

var remixer;
var player;
var track;
var remixed;

// temp for ease of hacking
var graph;

// These I think we need though
var currentLoc = 0;
var step
var dataType = "beats-conf";
var the_width = 1024;
var the_height = 768;

var chromaDict = {0: 'C', 1: 'C#', 2: 'D', 3: 'Eb', 4: 'E', 5: 'F', 6: 'F#', 7: 'G', 8: 'Ab', 9: 'A', 10: 'Bb', 11: 'B'}

function playFrom(index, marker) {
    player.stop();
    currentLoc = step * index;
    marker.attr('transform', 'translate(' + currentLoc + ')')
    var theArray = []
    if (dataType.indexOf('beats') != -1) {
        theArray = track.analysis.beats
    }
    else if (dataType.indexOf('tats') != -1) {
        theArray = track.analysis.tatums
    }
    else if (dataType.indexOf('segs') != -1) {
        theArray = track.analysis.segments
    }

    player.play(0, theArray.slice(index));
}

function getData(dataType) {
    var all_data = [];
    var the_series = [];
    if (dataType == 'beats-conf') {
        $('#graph-heading').text('Beat Confidence');
        for (var i = 0; i < track.analysis.beats.length; i++) {
            all_data.push({x: i, y: parseFloat(track.analysis.beats[i].confidence)});
        }
        the_series = [{color: 'steelblue', data: all_data}];
    }


    if (dataType == 'beats-dur') {
        $('#graph-heading').text('Beat Duration');
        for (var i = 0; i < track.analysis.beats.length; i++) {
            all_data.push({x: i, y: parseFloat(track.analysis.beats[i].duration)});
        }
        the_series = [{color: 'steelblue', data: all_data}];
    }

    if (dataType == 'tats-conf') {
        $('#graph-heading').text('Tatum Confidence');
        for (var i = 0; i < track.analysis.tatums.length; i++) {
            all_data.push({x: i, y: parseFloat(track.analysis.tatums[i].confidence)});
        }
        the_series = [{color: 'steelblue', data: all_data}];
    }

    if (dataType == 'tats-dur') {
        $('#graph-heading').text('Tatum Duration');
        for (var i = 0; i < track.analysis.tatums.length; i++) {
            all_data.push({x: i, y: parseFloat(track.analysis.tatums[i].duration)});
        }
        the_series = [{color: 'steelblue', data: all_data}];    
    the_series = [{color: 'steelblue', data: all_data}];
    }

    if (dataType == 'segs-conf') {
        $('#graph-heading').text('Segment Confidence');
        for (var i = 0; i < track.analysis.segments.length; i++) {
            all_data.push({x: i, y: parseFloat(track.analysis.segments[i].confidence)});
        }
        the_series = [{color: 'steelblue', data: all_data}];
    }

    if (dataType == 'segs-dur') {
        $('#graph-heading').text('Segment Duration');
        for (var i = 0; i < track.analysis.segments.length; i++) {
            all_data.push({x: i, y: parseFloat(track.analysis.segments[i].duration)});
        }
        the_series = [{color: 'steelblue', data: all_data}];    
    }

    if (dataType == 'segs-loud') {
        $('#graph-heading').text('Segment Loudness');
        for (var i = 0; i < track.analysis.segments.length; i++) {
            all_data.push({x: i, y: parseFloat(track.analysis.segments[i].loudness_max)});
        }
        the_series = [{color: 'steelblue', data: all_data}];    
    }

    if (dataType == 'segs-max-chroma') {
        $('#graph-heading').text('Segment Maximum Chroma');
        for (var i = 0; i < track.analysis.segments.length; i++) {

            chroma = []
            for (var j = 0; j < track.analysis.segments[i].pitches.length; j++) {
                chroma.push(parseFloat(track.analysis.segments[i].pitches[j]));
            }
            maxVal = Math.max.apply(Math, chroma);
            all_data.push({x: i, y: chroma.indexOf(maxVal)});
        }
        the_series = [{color: 'steelblue', data: all_data}];
    }

    if (dataType == 'segs-all-chroma') {
        $('#graph-heading').text('Segment All Chroma');
        var the_series = []
        var palette = new Rickshaw.Color.Palette();
        for (var j = 0; j < 12; j++) {
            the_series.push({name: chromaDict[j], color: palette.color(), data: []})
        }

        for (var i = 0; i < track.analysis.segments.length; i++) {
            for (var j = 0; j < track.analysis.segments[i].pitches.length; j++) {
               the_series[j]['data'].push({x: i, y: parseFloat(track.analysis.segments[i].pitches[j])});
            }
        }
    }

    if (dataType == 'segs-all-timbre') {
        $('#graph-heading').text('Segment All Timbre Weights');
        var the_series = []
        var palette = new Rickshaw.Color.Palette();
        for (var j = 0; j <12; j++) {
            the_series.push({color: palette.color(), data: []})
        }

        for (var i = 0; i < track.analysis.segments.length; i++) {
            for (var j = 0; j < track.analysis.segments[i].timbre.length; j++) {
               the_series[j]['data'].push({x: i, y: parseFloat(track.analysis.segments[i].timbre[j])});
            }
        }
    }

    return the_series;
}

function generateGraph(the_series, the_width, the_height) {
    $('#main-chart').empty();
    // ALL THE HUGE LONG GRAPHING CODE

    var render_method = 'line';
    if (dataType.indexOf('max-chroma') != -1) {
        render_method = 'scatterplot';
    }
    if (dataType.indexOf('all-chroma') != -1) {
        render_method = 'bar';
    }

    graph = new Rickshaw.Graph( {
            element: document.querySelector("#main-chart"),
            renderer: render_method,
            width: the_width,
            height: the_height,
            series: the_series,
    } );
    graph.render();

    // Generic Y-Axis
    var yAxis = new Rickshaw.Graph.Axis.Y({
        graph: graph
    });
    yAxis.render();

    // Generic X-Axis
    var xAxis = new Rickshaw.Graph.Axis.Time({
        graph: graph
    });
    xAxis.render();

    // wrestlng with hover details -- still need to fix this
    var hoverDetail = new Rickshaw.Graph.HoverDetail( {
        graph: graph,
        formatter: function(series, x, y) {
            var swatch = '<span class="detail_swatch" id="graph-index" style="background-color: ' + series.color + '">' + x + '</span>';
            var content = swatch + ": " + y;
            return content;
        }
    });

    // Conditional Legend stuff

    if (dataType.indexOf('all-chroma') != -1) {
        // need a legend!
        var legend = new Rickshaw.Graph.Legend( {
            graph: graph,
            element: document.getElementById('legend')

        } );
    }

    // Create the playback marker
    svg = d3.select('svg');
    var marker = svg.append("svg:line")
        .attr("x1", 0)
        .attr("y1", 0)
        .attr("x2", 0)
        .attr("y2", the_height)
        .style("stroke", "rgb(0,255,0)");


    // Set up the playback clicks
    $('.detail').on('click', 'div', function(event) {
        playFrom(parseInt($('#graph-index').text()), marker)
    });

    $('#main-chart').on('click', 'div', function(event) {
        playFrom(parseInt($('#graph-index').text()), marker)
    });

    $('svg').on('click', 'div', function(event) {
        playFrom(parseInt($('#graph-index').text()), marker)
    });

    // Move the marker along as the player plays
    player.addAfterPlayCallback(function() {
        currentLoc = currentLoc + step;
        marker.attr('transform', 'translate(' + currentLoc + ')')
    });
}

function update(newType) {
    dataType = newType;
    var the_series = getData(dataType);
    step = the_width / the_series[0]['data'].length;

    generateGraph(the_series, the_width, the_height);
    $('.btn').removeAttr('disabled');

}

function init() {
    $('.btn').attr('disabled','disabled');

    if (window.webkitAudioContext === undefined) {
        error("Sorry, this app needs advanced web audio. Your browser doesn't"
            + " support it. Try the latest version of Chrome");
    } else {
        var context = new webkitAudioContext();
        remixer = createJRemixer(context, $, apiKey);
        player = remixer.getPlayer();
        $("#info").text("Loading analysis data...");

        remixer.remixTrackById(trackID, trackURL, function(t, percent) {
            track = t;

            $("#info").text(percent + "% of the track loaded...");
            if (percent == 100) {
                $("#info").text(percent + "% of the track loaded, checking status");
            }

            if (track.status == 'ok') {
                $("#info").text("");
                $('.btn-original').removeAttr('disabled');
                // check out what the user wants to see and create the data
                update(dataType);


            } // end actual remix code
        });
    }
}

window.onload = init;
</script>

    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="index.html">Echo Nest Remix</a>
          <div class="nav-collapse collapse">
            <ul class="nav">
              <li><a href="http://echonest.github.com/remix/python.html">Python</a></li>
              <li><a href="http://echonest.github.com/remix/javascript.html">JavaScript</a></li>
              <li><a href="http://echonest.github.com/remix/examples.html">Examples</a></li>
              <li><a href="http://echonest.github.com/remix/who.html">Who</a></li>
            </ul>
          </div> <!--/.nav-collapse -->
        </div>
      </div>
    </div>  <!--/.navbar -->
    
    <div class="container">
        <div class="hero-unit">
            <h1>remix.js:  graph<h1>
            <p>See your music how an electrical engineer sees it.</p>
        </div>

        <div id="info"></div>

        <section>

            <h2 id='graph-heading'>The Graph</h2>
            <div id="main-chart">
            </div>

            <div id="legend_container">
                <div id="smoother" title="Smoothing"></div>
                <div id="legend"></div>
            </div>

            <br />
            <br />

            <div id="toggle-buttons">
                <p>
                    <button class='btn btn-primary' onClick="update('beats-conf');">Beats - Confidence</button>
                    <button class='btn btn-primary' onClick="update('beats-dur');">Beats - Duration</button>
                    <button class='btn btn-info' onClick="update('tats-conf');";>Tatums - Confidence</button>
                    <button class='btn btn-info' onClick="update('tats-dur');">Tatums - Duration</button>
                </p>
                <p>
                    <button class='btn btn-success' onClick="update('segs-conf');">Segments - Confidence</button>
                    <button class='btn btn-success' onClick="update('segs-dur');">Segments - Duration</button>
                    <button class='btn btn-success' onClick="update('segs-loud');">Segments - Max Loudness</button>
                    <button class='btn btn-success' onClick="update('segs-max-chroma');">Segments - Max Chroma</button>
                    <button class='btn btn-success' onClick="update('segs-all-chroma');">Segments - All Chroma</button>
                    <button class='btn btn-success' onClick="update('segs-all-timbre');">Segments - All Timbre</button>

                </p>
            </div>

            <br />

            <button class='btn btn-inverse btn-original' onClick="currentLoc = 0;player.play(0, track.analysis.beats);">Play </button>
            <button class='btn btn-original' onClick="player.stop()">Stop</button>
            </div>
        </section>

    <img src="http://the.echonest.com/media/images/logos/250x80_lt.gif" />
    </div> <!-- /container -->
</body>
</html>


